services:
  romm:
    image: rommapp/romm:latest
    container_name: romm
    restart: unless-stopped
    environment:
      - DB_HOST=romm-db-dev
      - DB_NAME=${DB_NAME:-romm}
      - DB_USER=${DB_USER:-romm}
      - DB_PASSWD=${DB_PASSWD:-romm}
      - REDIS_HOST=romm-valkey-dev
      - REDIS_PORT=6379
      # Production uses port 8080 internally
      - ROMM_PORT=8080 
    ports:
      # Maps your variable (default 5174) to the internal 8080
      - '${ROMM_FRONTEND_PORT:-5174}:8080'
    volumes:
      # Where your games go. You can change this to a host path later if needed.
      - romm-library:/romm/library
      - romm-assets:/romm/assets
      - romm-config:/romm/config
    depends_on:
      - romm-db-dev
      - romm-valkey-dev

  romm-db-dev:
    image: 'mariadb:11.3.2'
    container_name: romm-db-dev
    restart: unless-stopped
    env_file: .env
    environment:
      - 'MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWD:-rootpassword}'
      - 'MARIADB_DATABASE=${DB_NAME:-romm}'
      - 'MARIADB_USER=${DB_USER:-romm}'
      - 'MARIADB_PASSWORD=${DB_PASSWD:-romm}'
    volumes:
      - 'romm-db-dev:/var/lib/mysql'

  romm-valkey-dev:
    image: 'valkey/valkey:8'
    container_name: romm-valkey-dev
    restart: unless-stopped
    env_file: .env

  romm-postgres-dev:
    image: 'postgres:16-alpine'
    container_name: romm-postgresql-dev
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_PASSWORD: '${POSTGRES_PASSWORD:-postgres}'
      POSTGRES_USER: '${POSTGRES_USER:-postgres}'
      POSTGRES_DB: '${POSTGRES_DB:-authentik}'
    volumes:
      - 'postgres-db:/var/lib/postgresql/data'

  romm-authentik-server:
    image: 'ghcr.io/goauthentik/server:2024.10.4'
    container_name: romm-authentik-server
    restart: unless-stopped
    command: server
    env_file: .env
    environment:
      AUTHENTIK_REDIS__HOST: romm-valkey-dev
      AUTHENTIK_POSTGRESQL__HOST: romm-postgres-dev
      AUTHENTIK_POSTGRESQL__USER: '${POSTGRES_USER:-postgres}'
      AUTHENTIK_POSTGRESQL__NAME: '${POSTGRES_DB:-authentik}'
      AUTHENTIK_POSTGRESQL__PASSWORD: '${POSTGRES_PASSWORD:-postgres}'
      AUTHENTIK_SECRET_KEY: '${AUTHENTIK_SECRET_KEY:-secret-key-default}'
      AUTHENTIK_BOOTSTRAP_PASSWORD: '${AUTHENTIK_BOOTSTRAP_PASSWORD:-password}'
    volumes:
      - 'authentik-media:/media'
      - 'authentik-templates:/templates'
    ports:
      - '9001:9000'
      - '9444:9443'
    depends_on:
      - romm-postgres-dev
      - romm-valkey-dev

  romm-authentik-worker:
    image: 'ghcr.io/goauthentik/server:2024.10.4'
    container_name: romm-authentik-worker
    restart: unless-stopped
    command: worker
    env_file: .env
    environment:
      AUTHENTIK_REDIS__HOST: romm-valkey-dev
      AUTHENTIK_POSTGRESQL__HOST: romm-postgres-dev
      AUTHENTIK_POSTGRESQL__USER: '${POSTGRES_USER:-postgres}'
      AUTHENTIK_POSTGRESQL__NAME: '${POSTGRES_DB:-authentik}'
      AUTHENTIK_POSTGRESQL__PASSWORD: '${POSTGRES_PASSWORD:-postgres}'
      AUTHENTIK_SECRET_KEY: '${AUTHENTIK_SECRET_KEY:-secret-key-default}'
      AUTHENTIK_BOOTSTRAP_PASSWORD: '${AUTHENTIK_BOOTSTRAP_PASSWORD:-password}'
    volumes:
      - 'authentik-media:/media'
      - 'authentik-templates:/templates'
    depends_on:
      - romm-postgres-dev
      - romm-valkey-dev

volumes:
  romm-db-dev: null
  postgres-db: null
  authentik-media: null
  authentik-templates: null
  romm-library: null
  romm-assets: null
  romm-config: null
